import fs from "fs-extra";
import path from "path";
import { exec } from "child_process";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Root directories
const TEMPLATE_DIR = path.join(__dirname, "../android_template");
const OUTPUT_DIR = path.join(__dirname, "../uploads/builds");

/**
 * ğŸ”¨ Build a real Android APK and AAB from a base template
 * @param {Object} appData - appName, packageName, versionCode, versionName, websiteUrl
 */
export const buildAndroidApp = async (appData) => {
  const { appName, packageName, versionCode = 1, versionName = "1.0.0", websiteUrl } = appData;

  // Create temporary working directory
  const tempDir = path.join(__dirname, `../temp/${packageName}`);
  await fs.copy(TEMPLATE_DIR, tempDir);

  console.log(`ğŸ“¦ Copied template â†’ ${tempDir}`);

  // Inject package name, app name, and version dynamically
  const manifestPath = path.join(tempDir, "app/src/main/AndroidManifest.xml");
  const gradlePath = path.join(tempDir, "app/build.gradle");

  // âœ… Replace placeholders inside AndroidManifest.xml
  let manifest = await fs.readFile(manifestPath, "utf8");
  manifest = manifest
    .replace(/com\.example\.template/g, packageName)
    .replace(/App Template/g, appName);
  await fs.writeFile(manifestPath, manifest);

  // âœ… Inject values inside build.gradle
  let gradle = await fs.readFile(gradlePath, "utf8");
  gradle = gradle
    .replace(/applicationId ".*?"/, `applicationId "${packageName}"`)
    .replace(/versionCode \d+/, `versionCode ${versionCode}`)
    .replace(/versionName ".*?"/, `versionName "${versionName}"`);
  await fs.writeFile(gradlePath, gradle);

  console.log("ğŸ§© Updated manifest & Gradle config.");

  // ğŸ—ï¸ Run Gradle build (real)
  const buildCmd = `cd ${tempDir} && ./gradlew clean && ./gradlew assembleRelease bundleRelease`;
  console.log("âš™ï¸  Building APK & AAB...");

  await new Promise((resolve, reject) => {
    exec(buildCmd, { maxBuffer: 1024 * 1024 * 10 }, (error, stdout, stderr) => {
      if (error) {
        console.error("âŒ Build failed:", stderr);
        reject(error);
      } else {
        console.log("âœ… Gradle build success!");
        resolve(stdout);
      }
    });
  });

  // ğŸ“‚ Copy built files
  const apkSource = path.join(tempDir, "app/build/outputs/apk/release/app-release.apk");
  const aabSource = path.join(tempDir, "app/build/outputs/bundle/release/app-release.aab");

  const apkTarget = path.join(OUTPUT_DIR, `${packageName}.apk`);
  const aabTarget = path.join(OUTPUT_DIR, `${packageName}.aab`);

  await fs.ensureDir(OUTPUT_DIR);
  await fs.copy(apkSource, apkTarget);
  await fs.copy(aabSource, aabTarget);

  console.log("ğŸ“¤ Build files moved to uploads/builds.");

  // ğŸ§¹ Optional: Clean up temp folder
  await fs.remove(tempDir);

  // âœ… Return download URLs
  return {
    success: true,
    message: `ğŸ‰ ${appName} built successfully!`,
    apkLink: `http://localhost:5000/uploads/builds/${packageName}.apk`,
    aabLink: `http://localhost:5000/uploads/builds/${packageName}.aab`,
  };
};
